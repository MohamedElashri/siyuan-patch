name: release-cron

on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  create_release:
    name: get version and create release
    runs-on: ubuntu-latest
    steps:
      - name: Check upstream version and whether we already have it
        id: check
        run: |
          # Fetch upstream package.json
          pkg_json=$(curl -fsSL "https://raw.githubusercontent.com/siyuan-note/siyuan/master/app/package.json")
          upstream_ver=$(echo "$pkg_json" | grep '"version"' | head -1 | awk -F: '{print $2}' | sed 's/[", ]//g')
          tag="v${upstream_ver}"
          pkg_mgr=$(echo "$pkg_json" | grep '"packageManager"' | head -1 | awk -F: '{print $2}' | sed 's/[", ]//g')

          echo "upstream_tag=${tag}" >> $GITHUB_OUTPUT
          echo "package_manager=${pkg_mgr}" >> $GITHUB_OUTPUT
          echo "Upstream version: ${tag}"

          # Try to fetch release by tag from *our* repo
          # A 404 means it doesn't exist → safe to create
          status_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${tag}")

          if [[ "$status_code" == "200" ]]; then
            echo "Tag/release ${tag} already exists → skip."
            echo "needs_release=false" >> $GITHUB_OUTPUT
          elif [[ "$status_code" == "404" ]]; then
            echo "Tag/release ${tag} does NOT exist → will create."
            echo "needs_release=true" >> $GITHUB_OUTPUT
          else
            echo "Unexpected status: ${status_code} → aborting for safety."
            exit 1
          fi

      - name: Create Release
        if: ${{ steps.check.outputs.needs_release == 'true' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.check.outputs.upstream_tag }}
          name: ${{ steps.check.outputs.upstream_tag }}
          body: "Sync with upstream release"
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Dispatch builds
        if: ${{ steps.check.outputs.needs_release == 'true' }}
        run: |
          # Get workflow IDs
          resp=$(curl -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows")

          android_id=$(echo "$resp" | grep -A5 '"path".*release-android\.yml' | grep '"id"' | head -1 | awk '{print $2}' | tr -d ',')
          pc_id=$(echo "$resp" | grep -A5 '"path".*release-pc\.yml' | grep '"id"' | head -1 | awk '{print $2}' | tr -d ',')
          docker_id=$(echo "$resp" | grep -A5 '"path".*release-docker\.yml' | grep '"id"' | head -1 | awk '{print $2}' | tr -d ',')
          ios_id=$(echo "$resp" | grep -A5 '"path".*release-ios\.yml' | grep '"id"' | head -1 | awk '{print $2}' | tr -d ',')

          ver=${{ steps.check.outputs.upstream_tag }}
          pm=${{ steps.check.outputs.package_manager }}

          curl -fsSL -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${android_id}/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"version\":\"${ver}\",\"packageManager\":\"${pm}\"}}"

          curl -fsSL -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${pc_id}/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"version\":\"${ver}\",\"packageManager\":\"${pm}\"}}"

          curl -fsSL -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${docker_id}/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"version\":\"${ver}\"}}"

          curl -fsSL -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${ios_id}/dispatches" \
            -d "{\"ref\":\"main\",\"inputs\":{\"version\":\"${ver}\",\"packageManager\":\"${pm}\"}}"
